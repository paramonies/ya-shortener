## Содержание

1. [Задание](#Задание)
1. [Команды sql-migrate](#sql-migrate)

## Задание: <a name="Задание"></a>

Реализовать сервис для сокращения длинных URL.

Сервер должен должен иметь возможность сохранять информацию в БД, файле на диске, в оперативной памяти.

Приоритет имеет сохранение данных в БД.
При отсутствии переменной окружения `DATABASE_DSN` или флага командной строки `-d` или при их пустых значениях необходимо сохранять информацию в файл.
При отсутствии переменной окружения `FILE_STORAGE_PATH` или флага командной строки `-f` или при их пустых значениях необходимо сохранять информацию в оперативной памяти.

Сервис реализует следующие методы:

- `POST /` Метод создания сокращенного URL. Принимает в теле запроса строку URL для сокращения(как plain/text) и возвращает ответ с кодом 201 и сокращённым URL в виде текстовой строки в теле ответа(как plain/text).


- `POST /api/shorten` Метод создания сокращенного URL из json. Принимает в теле запроса JSON-объект `{"url":"<long_url>"}` и возвращающий в ответ объект `{"result":"<short_url>"}`


- `POST /api/shorten/batch`  Метод, принимающий в теле запроса множество URL для сокращения в формате:
  ```
  [
    {
      "correlation_id": "<строковый идентификатор>",
      "original_url": "<URL для сокращения>"
    },
    ...
  ]
  ```
  
  В качестве ответа хендлер должен возвращать данные в формате:
  ```
  [
    {
      "correlation_id": "<строковый идентификатор из объекта запроса>",
      "short_url": "<результирующий сокращённый URL>"
    },
    ...
  ]  
  ```
  

- `GET /{id}` Метод получения полного URL по сокращенному. Принимает в качестве id - идентификатор сокращённого URL и возвращает ответ с кодом 307 и оригинальным URL в HTTP-заголовке Location.


- `GET /api/user/urls` Метод, возвращающий пользователю все когда-либо сокращённые им URL в формате:
  ```
  [
    {
      "short_url": "http://...",
      "original_url": "http://..."
    },
    ...
  ]
  ```
  При отсутствии сокращённых пользователем URL хендлер должен отдавать HTTP-статус `204 No Content`




- `DELETE /api/user/urls` Метод, который принимает список идентификаторов сокращённых URL для удаления в формате:
  ```
  [ "a", "b", "c", "d", ...]
  ```
  В случае успешного приёма запроса, хендлер должен возвращать HTTP-статус `202 Accepted`. Фактический результат удаления может происходить позже — каким-либо образом оповещать пользователя об успешности или неуспешности не нужно.
  Успешно удалить URL может пользователь, его создавший. При запросе удалённого URL с помощью хендлера `GET /{id}` нужно вернуть статус `410 Gone`


- `GET /ping` Метод, который при запросе проверяет соединение с базой данных. При успешной проверке хендлер должен вернуть HTTP-статус `200 OK`, при неуспешной — `500 Internal Server Error`.


Имеется возможность конфигурирования сервиса с помощью переменных окружения:

- `SERVER_ADDRESS` Адрес запуска HTTP-сервера

- `BASE_URL` Базовый адрес результирующего сокращённого URL

- `DATABASE_DSN` Строка с адресом подключения к БД

- `FILE_STORAGE_PATH` Путь до файла на диске, содержащего все сокращённые URL


Имеется возможность конфигурирования сервиса с помощью флагов командной строки наравне с уже имеющимися переменными окружения:

- флаг `-a`, отвечающий за адрес запуска HTTP-сервера (переменная `SERVER_ADDRESS`)

- флаг `-b`, отвечающий за базовый адрес результирующего сокращённого URL (переменная `BASE_URL`)

- флаг `-d`, отвечающий параметры подключения к БД (переменная `DATABASE_DSN`)

- флаг `-f`, отвечающий за путь до файла с сокращёнными URL (переменная `FILE_STORAGE_PATH`).


 

Добавлена поддержка:

- аутентификации пользователя. Пользователю выдается симметрично подписанная cookie, содержащая уникальный идентификатор пользователя, если такой cookie не существует или она не проходит проверку подлинности

- gzip. Реализована возможность принимать запросы в сжатом формате (HTTP-заголовок `Content-Encoding`), отдавать сжатый ответ клиенту, который поддерживает обработку сжатых ответов (HTTP-заголовок `Accept-Encoding`)


## Команды sql-migrate <a name="sql-migrate"></a>

### Добавление новой миграции

`sql-migrate new -env=local migration-name`

### Применение миграций

`sql-migrate up -env=local`

### Откат миграций

Откатиться на одну миграцию: `sql-migrate down -env=local`

Откатиться на N миграций: `sql-migrate down -env=local -limit=N`